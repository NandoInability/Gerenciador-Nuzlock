<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nova Run</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<main class="container py-5">
    <div class="col-md-8 col-lg-6 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header text-center">
                <h2 class="fw-bold">Iniciando uma Nova Aventura</h2>
            </div>
            <div class="card-body p-4">
                <form th:action="${run.id == null} ? @{/runs} : @{/runs/{id}/editar(id=${run.id})}" th:object="${run}" method="post">

                    <input type="hidden" th:field="*{id}" />
                    <div class="mb-3">
                        <label for="jogo" class="form-label">Selecione o Jogo:</label>
                        <select class="form-select" id="jogo" th:field="*{jogo}" required>
                            <option value="">Escolha um jogo...</option>
                            <option th:each="j : ${jogos}" th:value="${j.id}" th:text="${j.nome}"></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="nomeDaRun" class="form-label">Dê um Nome para a Run:</label>
                        <input type="text" class="form-control" id="nomeDaRun" th:field="*{nomeDaRun}" placeholder="Ex: Minha primeira tentativa!" required>
                    </div>

                    <div class="mb-3">
                        <label for="jogador1" class="form-label">Seu Nickname:</label>
                        <input type="text" class="form-control" id="jogador1" th:field="*{jogador1}" required>
                    </div>

                    <div class="mb-3">
                        <label for="jogador2" class="form-label">Nickname do seu Parceiro:</label>
                        <input type="text" class="form-control" id="jogador2" th:field="*{jogador2}" required>
                    </div>

                    <hr class="my-4">

                    <fieldset class="border p-3 mb-3">
                        <legend class="float-none w-auto px-2 fs-6">Sorteio do Inicial - Jogador 1</legend>

                        <div class="mb-2">
                            <label class="form-label">Opção 1:</label>
                            <select class="form-select starter-p1-option" id="starter-p1-opt1">
                                <option value="">Selecione um Pokémon</option>
                                <option th:each="p : ${pokemons}" th:value="${p.id}" th:text="${p.name}"></option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Opção 2:</label>
                            <select class="form-select starter-p1-option" id="starter-p1-opt2">
                                <option value="">Selecione um Pokémon</option>
                                <option th:each="p : ${pokemons}" th:value="${p.id}" th:text="${p.name}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Opção 3:</label>
                            <select class="form-select starter-p1-option" id="starter-p1-opt3">
                                <option value="">Selecione um Pokémon</option>
                                <option th:each="p : ${pokemons}" th:value="${p.id}" th:text="${p.name}"></option>
                            </select>
                        </div>

                        <div class="text-center">
                            <button type="button" class="btn btn-success" id="sortear-p1-btn">Sortear!</button>
                        </div>

                        <div id="resultado-p1" class="text-center mt-3">
                        </div>
                    </fieldset>

                    <input type="hidden" id="starter-p1-choice" name="starterP1Id" />

                    <fieldset class="border p-3 mb-3">
                        <legend class="float-none w-auto px-2 fs-6">Sorteio do Inicial - Jogador 2</legend>

                        <div class="mb-2">
                            <label class="form-label">Opção 1:</label>
                            <select class="form-select starter-p2-option" id="starter-p2-opt1">
                                <option value="">Selecione um Pokémon</option>
                                <option th:each="p : ${pokemons}" th:value="${p.id}" th:text="${p.name}"></option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Opção 2:</label>
                            <select class="form-select starter-p2-option" id="starter-p2-opt2">
                                <option value="">Selecione um Pokémon</option>
                                <option th:each="p : ${pokemons}" th:value="${p.id}" th:text="${p.name}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Opção 3:</label>
                            <select class="form-select starter-p2-option" id="starter-p2-opt3">
                                <option value="">Selecione um Pokémon</option>
                                <option th:each="p : ${pokemons}" th:value="${p.id}" th:text="${p.name}"></option>
                            </select>
                        </div>

                        <div class="text-center">
                            <button type="button" class="btn btn-success" id="sortear-p2-btn">Sortear!</button>
                        </div>

                        <div id="resultado-p2" class="text-center mt-3">
                        </div>
                    </fieldset>

                    <input type="hidden" id="starter-p2-choice" name="starterP2Id" />

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="/" class="btn btn-secondary me-md-2">Cancelar</a>
                        <button type="submit" class="btn btn-primary" id="save-run-btn" disabled>Salvar e Começar!</button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</main>
<script>
    // Pega os elementos do HTML
    const sortearBtnP1 = document.getElementById('sortear-p1-btn');
    const resultadoDivP1 = document.getElementById('resultado-p1');
    const opcoesSelectP1 = document.querySelectorAll('.starter-p1-option');
    const escolhaInputP1 = document.getElementById('starter-p1-choice');

    const sortearBtnP2 = document.getElementById('sortear-p2-btn');
    const resultadoDivP2 = document.getElementById('resultado-p2');
    const opcoesSelectP2 = document.querySelectorAll('.starter-p2-option');
    const escolhaInputP2 = document.getElementById('starter-p2-choice');

    const saveRunBtn = document.getElementById('save-run-btn'); // Pega o botão de salvar

    // Função que verifica se pode habilitar o botão de salvar
    function checkIfReadyToSave() {
        const p1Sorteado = escolhaInputP1.value !== '';
        const p2Sorteado = escolhaInputP2.value !== '';

        if (p1Sorteado && p2Sorteado) {
            saveRunBtn.disabled = false; // Habilita o botão
        } else {
            saveRunBtn.disabled = true; // Mantém desabilitado
        }
    }

    // Adiciona o "ouvinte" de clique no botão de sortear do JOGADOR 1
    sortearBtnP1.addEventListener('click', function() {
        const opcoesSelecionadas = [];
        opcoesSelectP1.forEach(selectElement => {
            if (selectElement.value !== '') {
                opcoesSelecionadas.push({ id: selectElement.value, name: selectElement.options[selectElement.selectedIndex].text });
            }
        });
        if (opcoesSelecionadas.length === 0) {
            resultadoDivP1.innerHTML = '<p class="text-danger">Selecione pelo menos uma opção!</p>';
            return;
        }
        const indiceSorteado = Math.floor(Math.random() * opcoesSelecionadas.length);
        const pokemonSorteado = opcoesSelecionadas[indiceSorteado];
        resultadoDivP1.innerHTML = `<p class="h5">O Pokémon inicial sorteado é:</p><p class="display-6 fw-bold text-primary">${pokemonSorteado.name}</p>`;
        escolhaInputP1.value = pokemonSorteado.id;

        checkIfReadyToSave(); // Verifica se pode habilitar o botão de salvar
    });

    // Adiciona o "ouvinte" de clique no botão de sortear do JOGADOR 2
    sortearBtnP2.addEventListener('click', function() {
        const opcoesSelecionadas = [];
        opcoesSelectP2.forEach(selectElement => {
            if (selectElement.value !== '') {
                opcoesSelecionadas.push({ id: selectElement.value, name: selectElement.options[selectElement.selectedIndex].text });
            }
        });
        if (opcoesSelecionadas.length === 0) {
            resultadoDivP2.innerHTML = '<p class="text-danger">Selecione pelo menos uma opção!</p>';
            return;
        }
        const indiceSorteado = Math.floor(Math.random() * opcoesSelecionadas.length);
        const pokemonSorteado = opcoesSelecionadas[indiceSorteado];
        resultadoDivP2.innerHTML = `<p class="h5">O Pokémon inicial sorteado é:</p><p class="display-6 fw-bold text-primary">${pokemonSorteado.name}</p>`;
        escolhaInputP2.value = pokemonSorteado.id;

        checkIfReadyToSave(); // Verifica se pode habilitar o botão de salvar
    });
</script>
</body>
</html>